"use strict";(self["webpackChunkstrapi_catalog_viewer"]=self["webpackChunkstrapi_catalog_viewer"]||[]).push([[231],{5231:function(e,t,a){a.r(t),a.d(t,{default:function(){return j}});var n=a(6768),o=a(4232),i=a(5130);const l={class:"container mt-4"},s={key:0,class:"text-center"},r={key:1,class:"alert alert-danger"},c={key:2},d={class:"d-flex justify-content-between align-items-center mb-3"},u={class:"catalog-container"},g=["onClick"],p={class:"card-body"},h=["src"],m={class:"products-grid"},N=["src","alt"],k=["onMousedown"],v=["onClick"],w=["href"],y={class:"page-number"},b={key:1,class:"page-placeholder"},f=["onClick"],C={class:"card-body"},D=["src"],L={class:"products-grid"},E=["src","alt"],_=["onMousedown"],X=["onClick"],M={class:"note-content-wrapper"},I=["href"],x={class:"page-number"},Q={key:3,class:"page-placeholder"};function F(e,t,a,F,S,U){return(0,n.uX)(),(0,n.CE)("div",l,[S.loading?((0,n.uX)(),(0,n.CE)("div",s,[...t[9]||(t[9]=[(0,n.Lk)("div",{class:"spinner-border",role:"status"},[(0,n.Lk)("span",{class:"visually-hidden"},"Chargement...")],-1)])])):(0,n.Q3)("",!0),S.error?((0,n.uX)(),(0,n.CE)("div",r,(0,o.v_)(S.error),1)):(0,n.Q3)("",!0),S.catalog?((0,n.uX)(),(0,n.CE)("div",c,[(0,n.Lk)("div",d,[(0,n.Lk)("h1",null,(0,o.v_)(S.catalog.title),1),(0,n.Lk)("button",{class:"btn btn-outline-primary",onClick:t[0]||(t[0]=(...e)=>U.toggleNoteMode&&U.toggleNoteMode(...e))},(0,o.v_)(S.isNoteMode?"Quitter le mode Notes":"Activer le mode Notes"),1)]),t[12]||(t[12]=(0,n.Lk)("hr",null,null,-1)),t[13]||(t[13]=(0,n.Lk)("h2",null,"Pages",-1)),(0,n.Lk)("div",u,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(U.pairedPages,(e,a)=>((0,n.uX)(),(0,n.CE)("div",{key:a,class:"page-pair"},[e[0]?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"page left",onClick:t=>U.startNewNote(t,e[0])},[(0,n.Lk)("div",p,[e[0].active_image_version&&e[0].active_image_version.fichier_jpeg?((0,n.uX)(),(0,n.CE)("img",{key:0,src:U.getStrapiMediaUrl(e[0].active_image_version.fichier_jpeg.url),alt:"Version Image",class:"version-image"},null,8,h)):(0,n.Q3)("",!0),(0,n.Lk)("div",m,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e[0].products,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"product-item"},[e.image?((0,n.uX)(),(0,n.CE)("img",{key:0,src:U.getStrapiMediaUrl(e.image.url),alt:e.name,class:"product-image"},null,8,N)):(0,n.Q3)("",!0),(0,n.Lk)("strong",null,(0,o.v_)(e.name),1),(0,n.Lk)("span",null,"$"+(0,o.v_)(e.price),1),(0,n.Lk)("p",null,(0,o.v_)(e.description),1)]))),128))])]),S.isNoteMode?((0,n.uX)(),(0,n.CE)(n.FK,{key:0},[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e[0].notes,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.documentId,class:(0,o.C4)(["note-bubble",{"is-dragging":S.draggedNote&&S.draggedNote.note.documentId===e.documentId}]),style:(0,o.Tr)({top:e.y+"%",left:e.x+"%"}),onMousedown:(0,i.D$)(t=>U.startDrag(t,e),["stop"])},[(0,n.Lk)("button",{onClick:(0,i.D$)(t=>U.deleteNote(e),["stop"]),class:"delete-note-btn"},"×",8,v),e.attachment?((0,n.uX)(),(0,n.CE)("a",{key:0,href:U.getStrapiMediaUrl(e.attachment.url),target:"_blank",class:"me-2 paperclip-link"},[...t[10]||(t[10]=[(0,n.Lk)("i",{class:"bi bi-paperclip"},null,-1)])],8,w)):(0,n.Q3)("",!0),(0,n.Lk)("p",null,(0,o.v_)(e.content),1)],46,k))),128)),S.newNoteData&&S.newNoteData.page===e[0].id?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"new-note-form",style:(0,o.Tr)({top:S.newNoteData.y+"%",left:S.newNoteData.x+"%"})},[(0,n.bo)((0,n.Lk)("textarea",{"onUpdate:modelValue":t[1]||(t[1]=e=>S.newNoteData.content=e),placeholder:"Votre note...",class:"form-control mb-2"},null,512),[[i.Jo,S.newNoteData.content]]),(0,n.Lk)("input",{type:"file",onChange:t[2]||(t[2]=(...e)=>U.onFileSelected&&U.onFileSelected(...e)),class:"form-control-file mb-2"},null,32),(0,n.Lk)("button",{onClick:t[3]||(t[3]=(0,i.D$)((...e)=>U.submitNewNote&&U.submitNewNote(...e),["stop"])),class:"btn btn-sm btn-primary"},"Enregistrer"),(0,n.Lk)("button",{onClick:t[4]||(t[4]=(0,i.D$)((...e)=>U.cancelNewNote&&U.cancelNewNote(...e),["stop"])),class:"btn btn-sm btn-secondary"},"Annuler")],4)):(0,n.Q3)("",!0)],64)):(0,n.Q3)("",!0),(0,n.Lk)("div",y,(0,o.v_)(e[0].page_number),1)],8,g)):((0,n.uX)(),(0,n.CE)("div",b)),e[1]?((0,n.uX)(),(0,n.CE)("div",{key:2,class:"page right",onClick:t=>U.startNewNote(t,e[1])},[(0,n.Lk)("div",C,[e[1].active_image_version&&e[1].active_image_version.fichier_jpeg?((0,n.uX)(),(0,n.CE)("img",{key:0,src:U.getStrapiMediaUrl(e[1].active_image_version.fichier_jpeg.url),alt:"Version Image",class:"version-image"},null,8,D)):(0,n.Q3)("",!0),(0,n.Lk)("div",L,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e[1].products,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"product-item"},[e.image?((0,n.uX)(),(0,n.CE)("img",{key:0,src:U.getStrapiMediaUrl(e.image.url),alt:e.name,class:"product-image"},null,8,E)):(0,n.Q3)("",!0),(0,n.Lk)("strong",null,(0,o.v_)(e.name),1),(0,n.Lk)("span",null,"$"+(0,o.v_)(e.price),1),(0,n.Lk)("p",null,(0,o.v_)(e.description),1)]))),128))])]),S.isNoteMode?((0,n.uX)(),(0,n.CE)(n.FK,{key:0},[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e[1].notes,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.documentId,class:(0,o.C4)(["note-bubble",{"is-dragging":S.draggedNote&&S.draggedNote.note.documentId===e.documentId}]),style:(0,o.Tr)({top:e.y+"%",left:e.x+"%"}),onMousedown:(0,i.D$)(t=>U.startDrag(t,e),["stop"])},[(0,n.Lk)("button",{onClick:(0,i.D$)(t=>U.deleteNote(e),["stop"]),class:"delete-note-btn"},"×",8,X),(0,n.Lk)("div",M,[e.attachment?((0,n.uX)(),(0,n.CE)("a",{key:0,href:U.getStrapiMediaUrl(e.attachment.url),target:"_blank",class:"paperclip-link"},[...t[11]||(t[11]=[(0,n.Lk)("i",{class:"bi bi-paperclip"},null,-1)])],8,I)):(0,n.Q3)("",!0),(0,n.Lk)("p",null,(0,o.v_)(e.content),1)])],46,_))),128)),S.newNoteData&&S.newNoteData.page===e[1].id?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"new-note-form",style:(0,o.Tr)({top:S.newNoteData.y+"%",left:S.newNoteData.x+"%"})},[(0,n.bo)((0,n.Lk)("textarea",{"onUpdate:modelValue":t[5]||(t[5]=e=>S.newNoteData.content=e),placeholder:"Votre note...",class:"form-control mb-2"},null,512),[[i.Jo,S.newNoteData.content]]),(0,n.Lk)("input",{type:"file",onChange:t[6]||(t[6]=(...e)=>U.onFileSelected&&U.onFileSelected(...e)),class:"form-control-file mb-2"},null,32),(0,n.Lk)("button",{onClick:t[7]||(t[7]=(0,i.D$)((...e)=>U.submitNewNote&&U.submitNewNote(...e),["stop"])),class:"btn btn-sm btn-primary"},"Enregistrer"),(0,n.Lk)("button",{onClick:t[8]||(t[8]=(0,i.D$)((...e)=>U.cancelNewNote&&U.cancelNewNote(...e),["stop"])),class:"btn btn-sm btn-secondary"},"Annuler")],4)):(0,n.Q3)("",!0)],64)):(0,n.Q3)("",!0),(0,n.Lk)("div",x,(0,o.v_)(e[1].page_number),1)],8,f)):((0,n.uX)(),(0,n.CE)("div",Q))]))),128))])])):(0,n.Q3)("",!0)])}a(4114);var S=a(5362),U={name:"CatalogDetail",props:{id:{type:String,required:!0}},data(){return{catalog:null,loading:!0,error:null,strapiBaseUrl:"https://strapi.scarpellino.fr",newNoteData:null,isNoteMode:!1,notesLoaded:!1,draggedNote:null}},computed:{pairedPages(){if(!this.catalog||!this.catalog.pages)return[];const e=[...this.catalog.pages].sort((e,t)=>e.page_number-t.page_number),t=[];e.length>0&&t.push([null,e[0]]);for(let a=1;a<e.length;a+=2)a+1<e.length?t.push([e[a],e[a+1]]):t.push([e[a],null]);return t}},async created(){this.fetchInitialData()},methods:{getStrapiMediaUrl(e){return e?`${this.strapiBaseUrl}${e}`:""},async fetchInitialData(){this.loading=!0;try{const e=await S.A.getCatalog(this.id);this.catalog=e.data.data}catch(e){this.error="Erreur lors du chargement du catalogue.",console.error(e)}finally{this.loading=!1}},async toggleNoteMode(){this.isNoteMode=!this.isNoteMode,this.isNoteMode&&!this.notesLoaded&&await this.fetchNotes()},async fetchNotes(){this.loading=!0;try{const e=await S.A.getCatalogWithNotes(this.id);this.catalog=e.data.data,this.notesLoaded=!0}catch(e){this.error="Erreur lors du chargement des notes.",console.error(e)}finally{this.loading=!1}},startNewNote(e,t){if(!this.isNoteMode||!t)return;if(this.newNoteData)return;if(e.target.closest(".note-bubble")||e.target.closest(".new-note-form"))return;const a=e.currentTarget.getBoundingClientRect(),n=(e.clientX-a.left)/a.width*100,o=(e.clientY-a.top)/a.height*100;this.newNoteData={x:n,y:o,page:t.id,content:"",attachment:null}},onFileSelected(e){const t=e.target.files[0];if(t){this.newNoteData.attachment=t;const e=new FileReader;e.readAsDataURL(t)}},async submitNewNote(){if(this.newNoteData&&this.newNoteData.content)try{let e=null;if(this.newNoteData.attachment){const t=await S.A.upload(this.newNoteData.attachment);e=t.data[0].id}const t={...this.newNoteData,attachment:e};await S.A.createNote(t),await this.fetchNotes(),this.newNoteData=null}catch(e){console.error("Erreur lors de l'ajout de la note:",e),alert("Erreur lors de l'ajout de la note. Veuillez réessayer.")}else alert("Veuillez saisir un contenu pour la note.")},cancelNewNote(){this.newNoteData=null},async deleteNote(e){if(confirm("Êtes-vous sûr de vouloir supprimer cette note ?"))try{await S.A.deleteNote(e.documentId),await this.fetchNotes()}catch(t){console.error("Erreur lors de la suppression de la note:",t),alert("Erreur lors de la suppression de la note.")}},startDrag(e,t){if(!this.isNoteMode)return;const a=e.target.closest(".page");if(!a)return;const n=a.getBoundingClientRect();this.draggedNote={note:t,initialX:t.x,initialY:t.y,initialMouseX:e.clientX,initialMouseY:e.clientY,pageWidth:n.width,pageHeight:n.height},window.addEventListener("mousemove",this.handleDrag),window.addEventListener("mouseup",this.stopDrag)},handleDrag(e){if(!this.draggedNote)return;e.preventDefault();const{note:t,initialX:a,initialY:n,initialMouseX:o,initialMouseY:i,pageWidth:l,pageHeight:s}=this.draggedNote,r=e.clientX-o,c=e.clientY-i,d=r/l*100,u=c/s*100;t.x=a+d,t.y=n+u},async stopDrag(){if(!this.draggedNote)return;const{note:e,initialX:t,initialY:a}=this.draggedNote;if(window.removeEventListener("mousemove",this.handleDrag),window.removeEventListener("mouseup",this.stopDrag),e.x!==t||e.y!==a)try{await S.A.updateNote(e.documentId,{x:e.x,y:e.y})}catch(n){console.error("Erreur lors de la mise à jour de la position de la note:",n),alert("Impossible de sauvegarder la nouvelle position de la note."),e.x=t,e.y=a}this.draggedNote=null}}},$=a(1241);const A=(0,$.A)(U,[["render",F],["__scopeId","data-v-3c4a5d6e"]]);var j=A}}]);
//# sourceMappingURL=231.5d5d529a.js.map